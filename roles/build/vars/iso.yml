---
builders:
  virtualbox_iso:
    disk_size: 20240
    guest_additions_path: /tmp/VBoxGuestAdditions.iso
    headless: no
    http_directory: 'build/{{ spec.distribution }}'
    output_directory: 'build/{{ spec.distribution }}/{{ spec.version }}/{{ spec.target }}'
    ssh_password:  '{{ spec.ssh_password }}'
    # ssh_port: 22
    ssh_username: '{{ spec.ssh_username }}'
    ssh_wait_timeout: 10000s
    type: virtualbox-iso
    vm_name: '{{ spec.vm_name }}'
    vboxmanage:
      - '["modifyvm", "{% raw %}{{.Name}}{% endraw %}", "--memory", "1024"]'
      - '["modifyvm", "{% raw %}{{.Name}}{% endraw %}", "--cpus", "1"]'

provisioners:
  _order: [guest_additions, ansible]
  # NOTE: probably get rid of sudo provisioner as wheel is added by the preseed
  sudo:
    type: shell
    execute_command: "echo '{{ spec.ssh_username }}' {% raw %}| {{ .Vars }} sudo -E -S sh '{{ .Path }}'{% endraw %}"
    inline:
      - "echo '%wheel    ALL=(ALL)  NOPASSWD:ALL' >> /etc/sudoers"
  # NOTE: guest_additions is debian specific as it invokes m-a prepare
  guest_additions:
    type: shell
    inline:
      - "sleep 3"
      - "echo 'yes' | sudo m-a prepare"
      - "sudo mkdir /tmp/vboxguest"
      - "sudo mount -t iso9660 -o loop /tmp/VBoxGuestAdditions.iso /tmp/vboxguest"
      - "cd /tmp/vboxguest"
      - "sudo ./VBoxLinuxAdditions.run"
      - "cd /tmp"
      - "sudo umount /tmp/vboxguest"
      - "sudo rmdir /tmp/vboxguest"
      - "rm /tmp/VBoxGuestAdditions.iso"

post_processors:
  vagrant:
    type: vagrant
    keep_input_artifact: yes
    output: 'boxes/{{ spec.owner }}/{{ spec.version }}-{{ spec.target }}.box'
