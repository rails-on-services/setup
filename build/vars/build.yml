---
builders:
  virtualbox_ovf:
    guest_additions_mode: disable
    headless: no
    output_directory: 'build/{{ spec.distribution }}/{{ spec.version }}/{{ spec.target }}'
    shutdown_command: "echo 'halt -p' > shutdown.sh; echo 'vagrant'|sudo -S sh 'shutdown.sh'"
    source_path: 'build/{{ spec.distribution }}/{{ spec.version }}/{{ spec.source }}/{{ spec.vm_name }}.ovf'
    ssh_username: '{{ spec.ssh_username }}'
    ssh_password:  '{{ spec.ssh_password }}'
    ssh_wait_timeout: 30s
    type: virtualbox-ovf
    vm_name: '{{ spec.vm_name }}'

post_processors:
  _order: [vagrant, box_meta]
  vagrant:
    type: vagrant
    keep_input_artifact: yes
    output: 'boxes/{{ spec.owner }}/{{ spec.version }}-{{ spec.target }}.box'
  box_meta:
    type: shell-local
    inline:
      - './json.rb {{ spec.work_dir }}/boxes {{ spec.owner }} {{ spec.version }}-{{ spec.target }} {{ spec.box_version }}'
